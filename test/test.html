<html> 
<head> 
  <title>jquery-wakeful test</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" /> 
  <script src="jquery-1.6.2.min.js"></script>

  <script src="qunit-75dae0b/qunit.js"></script>
  <link rel="stylesheet" href="qunit-75dae0b/qunit.css" type="text/css" />

  <script src="../jquery-wakeful.js"></script>

  <script>
    var api = $.Wakeful({
      baseUrl: "http://localhost:4513/api/"
    });

    function log() {
      var args = Array.prototype.slice.call(arguments);
      var cur = QUnit.config.current? QUnit.config.current.testName : "<none>";
      args.splice(0, 0, cur + ":");
      console.log.apply(console, args);
    }

    function asyncFail(reason) {
      return function() {
        start();
        log("asyncFail arguments:", arguments);
        ok(false, reason || "asyncFail (see console.log)");
      }
    }

    $(document).ready(function() {
      $.each([
        ["live get(args, kwargs)", [["arg"], {kw: "kwval"}], {0: "arg", kw: "kwval"}],
        ["live get(args)", [["arg"]], {0: "arg"}],
        ["live get(kwargs)", [{kw: "kwval"}], {kw: "kwval"}],
        ["live get()", [], {}]
      ], function() {
        var args = this[1];
        var expected = this[2];
        args.splice(0, 0, "echo");
        args.push(function(result) {
          start();
          deepEqual(result, expected);
        });
        args.push(asyncFail());
        asyncTest(this[0], function() {
          api.get.apply(api, args);
        });
      });

      $.each([
        ["getArgs with nothing", "/foo", "/foo?a=b"],
        ["getArgs with just ?", "/foo?", "/foo?a=b"],
        ["getArgs with existing args", "/foo?x=y", "/foo?x=y&a=b"],
      ], function() {
        var url = this[1];
        var expected = this[2];
        test(this[0], function() {
          var settings = $.extend(api.defaultCallSettings(), {
            url: url,
            getArgs: { a: "b" }
          });
          api.callAppendGetArgs(settings);
          equal(settings.url, expected);
        });
      });

      $.each([
        ["expandUrlVariables with args", "/{1}", "/one", {args: ["zero", "two"]}],
        ["expandUrlVariables with kwargs", "/{foo}", "/foo", {kwargs: {bar: "bar"}}],
        ["expandUrlVariables with invalid", "/{invalid}", "/{invalid}", {}],
      ], function() {
        var url = this[1];
        var expectedUrl = this[2];
        var _expectedArgs = this[3];
        test(this[0], function() {
          var origSettings = {
            url: url,
            args: ["zero", "one", "two"],
            kwargs: { foo: "foo", bar: "bar" }
          };
          var expectedArgs = $.extend({}, origSettings, _expectedArgs);
          var settings = $.extend(api.defaultCallSettings(), origSettings);
          api.callExpandUrlVariables(settings);
          equal(settings.url, expectedUrl);
          deepEqual(settings.args, expectedArgs.args);
          deepEqual(settings.kwargs, expectedArgs.kwargs);
        });
      });

    });
  </script>

</head>

<body>
  <h1 id="qunit-header">jquery-wakeful tests</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
</body>
</html>

